-----
### 서버의 고장을 멱등 연산으로 처리하기
-----
1. 클라이언트가 서버로 메세지를 전송했을 때, 응답이 없는 경우가 존재
   - 여러 원인이 있을 수 있음 : 네트워크 상에서 메세지가 손실되었을 수도 있음 (실제 환경에서 네트워크 상에서 메세지는 손실됨)
   - 요청 메세지가 손실되었을 수 있고, 응답 메세지가 손실되었을 수 있음 : 두 경우 모두, 클라이언트는 응답을 받지 못하게 됨
   - 서버가 크래시되어 메세지에 응답하지 못하는 경우도 존재할 수 있음 : 얼마 후, 서버가 다시 시작되겠지만, 그 동안 전송된 모든 요청들은 손실될 수 있음

2. 서버 제 때 응답하지 않으면, NFSv2에서 클라이언트는 모든 종류의 고장들을 하나의 일관성 있고 정교한 방식으로 대처
   - 요청을 재전송하며, 구체적으로 클라이언트는 요청을 전송한 후 타이머를 설정
   - 타이머가 종료하기 전에 응답이 오면, 해당 타이머는 취소
   - 응답을 받기 전 타이머가 종료한다면, 클라이언트는 요청 처리가 되지 않았다고 간주하고 재전송하며, 만약 서버의 응답이 도착하면 문제가 해결된 것

3. 재시도를 통해 문제를 쉽게 해결할 수 있는 근본 원인은 NFS 요청이 갖고 있는 중요 성질에 기인
   - 바로 연산의 멱등성(Idempotent)이며, 어떤 연산이 멱등연산이라고 불리면, 그 연산을 여러 차례 수행하여 얻는 결과가 한 번만 수행했을 때 얻는 결과와 동일함을 뜻함
   - 즉, 멱등성이란 연산을 수행하더라도 동일한 값이 유지되는 성질을 의미하며, 시스템의 신뢰성을 담보할 수 있는 매우 유용한 성질임 : 연산이 성공할 때까지, 계속 연산을 요청하면 됨
   - 예를 들어, 메모리의 특정 위치에 어떤 값을 세 번 저장한다면, 그것은 한 번만 저장하는 것과 같은 결과를 가져오며, 메모리에 값을 저장이라는 연산은 멱등 연산
   - 반면 카운터를 세 번 증가시키는 것은 한 번만 하는 것과 결과가 다르므로, 카운터 증가는 멱등 연산이 아님
   - 데이터를 읽기만 하는 연산은 당연하게 멱등연산이며, 데이터 갱신의 연산의 경우 멱등연산인지 아닌지 판단하기 위해 확인해야 함

4. NFS에서 크래시 복구 설계의 핵심은 주요 연산들의 멱등성
   - LOOKUP과 READ 요청은 파일 서버에서 정보를 읽기만하고 갱신하지 않으므로 평범한 멱등연산
   - WRITE 연산도 역시 멱등 연산
     + 예를 들어, WRITE가 실패했다면 클라이언트는 단순히 그 연산을 재시도하면 됨
     + WRITE 메세지는 데이터와 길이 그리고 데이터를 써야 할 (중요한) 정확한 오프셋을 포함
     + 그러므로 여러 번 쓰기 연산을 하더라도 한 번 수행한 결과와 동일하므로 이 연산을 반복할 수 있음

   - 세 종류의 손실
<div align="center">
<img src="https://github.com/user-attachments/assets/0ca1bab0-8848-450b-9573-3092835135ba">
</div>

   - 이와 같은 방식으로 클라이언트는 모든 타임아웃들을 일관된 방식으로 다룰 수 있음
     + WRITE 요청이 손실되었으면(케이스 1), 클라이언트는 쓰기 요청을 실행하고, 정상이 됨
     + 처음 요청을 전달한 시점에는 서버가 다운이었는데, 두 번째 요청할 때는 다시 살아나서 실행 중인 경우에도 똑같이 모든 동작이 원하는 대로 수행 (케이스 2)
     + 마지막 경우로, 서버가 WRITE 요청을 받아 디스크로 쓰기 요청을 하였고, 클라이언트도 응답을 전송하였는데, 이 응답이 손실되었다면 (케이스 3), 클라이언트가 재요청 할 수도 있음
     + 서버가 이 요청을 다시 받게 되면 처음 받은 것처럼 똑같이 다시 수행하며, 서버는 데이터를 디스크에 쓰고 이전과 같이 응답
     + 만약, 클라이언트가 이번에는 응답을 받으면 정상적으로 동작 : 따라서, 클라이언트는 두 번의 메세지 손실과 서버 고장을 일관성있게 해결

5. 참고 : 어떤 연산들은 멱등 연산으로 만들기 어려움
   - 예를 들어, 디렉터리를 만들려고 했는데 mkdir 요청이 실패했다는 정보를 받았음
   - NFS에서 파일 서버가 MKDIR 프로토콜 메세지를 받아서 성공적으로 처리하였지만 응답이 도중에 손실이 되었을 때, 그 사실을 모르는 클라이언트는 요청을 반복하지만 첫 번째 요청때에 이미 성공적으로 디렉토리를 생성한 서버는 클라이언트에게 실패했다고 알림
   - 하지만, 첫 요청에 이미 처리를 성공적으로 했으므로 재시도를 실패한 것일 뿐임
