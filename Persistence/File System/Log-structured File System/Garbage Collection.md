-----
### 가비지 컬렉션
-----
1. LFS는 갱신된 파일(아이노드와 데이터)을 계속 디스크의 새로운 위치에 씀
   - 이 방법은 쓰기 동작을 효율적으로 수행하는 것이 목적이지만, 예전 값들은 디스크에 그대로 남아있게 됨
   - 사용되지는 않지만 디스크의 공간을 차지하고 있음
   - 이러한 예전 내용들을 가비지(Garbage, 쓰레기)라고 부름

2. 예제) 아이노드 번호 k가 기존 파일의 데이터 블럭 D0을 참조하는 경우를 생각
   - 데이터 블럭을 덮어쓰면 새로운 아이노드와 새로운 블럭이 생성
   - 그 결과로 디스크 상의 LFS의 자료 구조는 다음과 같이 비슷한 상태로 배치 (간단히 표현하기 위해 imap과 다른 자료 구조들은 표현하지 않고, 새 아이노드를 가리키는 새로운 imap 청크도 역시 디스크에 기록되어야 함)
<div align="center">
<img src="https://github.com/user-attachments/assets/4ac1c89d-9547-4bee-9957-7481be8f0652">
</div>

   - 다음 그림을 보면 디스크에 두 버전의 아이노드와 데이터 블럭이 있는 거을 볼 수 있음
   - 하나는 이전 것(좌측)이고 다른 하나는 현재 버전(우측)
   - 데이터를 덮어쓰는 간단한 동작을 위해 LFS는 여러 개의 새로운 자료 구조를 디스크에 기록
   - 이전 버전의 블럭들도 여전히 디스크에 존재

3. 예제) 원래의 파일 k에 한 개의 블럭을 추가하는 경우
   - 이 경우 새로운 버전의 아이노드가 생성되며, 예전의 데이터 블럭은 여전히 옛 버전의 아이노드가 가리키고 있음
   - 그러므로 내용은 여전히 남아있으며, 현재 파일 시스템의 일부로 남아있음
<div align="center">
<img src="https://github.com/user-attachments/assets/c05218f2-08d1-4bbe-ad5c-758b2f8aea5b">
</div>

   - 구 버전의 아이노드와 데이터 블럭 등은 파일을 예전 버전으로 복원하는데 상요 가능 (실수로 파일을 덮어쓰거나 삭제한 경우 유용)
   - 이와 같이 파일의 여러 버전을 관리하는 파일 시스템을 버전 파일 시스템(Versioning File System)

4. 하지만, LFS는 파일의 최신 버전만을 유지
   - LFS는 주기적으로 (백그라운드로) 이전 버전의 데이터와 아이노드 그리고 다른 자료 구조들을 찾아 제거
   - 이 작업을 디스크 블럭들을 해제하여 추후 쓰기 요청에 사용될 수 있도록 함
   - 이 작업은 가비지 컬렉션의 일종으로, 프로그램 언어에서는 프로그램이 사용하지 않는 메모리를 자동적으로 해제하는 동작을 일컫음
  
5. 앞에서 세그먼트를 설명할 때, 디스크에 큰 단위로 쓸 수 있으므로 LFS에서 세그먼트가 중요함
   - 세그먼트가 효율적인 가비지 컬렉션 작업에도 필수적임
   - 만약에 LFS의 가비지 컬렉터(Garbage Collector)가 데이터 블럭과 아이노드 등을 하나씩 순회하며 해제할 경우
     + 파일 시스템에는 할당 해제된 몇 개의 구멍(Hole)과 할당된 디스크의 공간이 섞여 있는 상태가 될 것
     + 순차적으로 쓸 수 있는 연속적 영역을 찾을 수 없으므로 LFS의 쓰기 성능은 현저히 저하
   - 따라서, LFS의 가비지 컬렉터는 세그먼트 단위로 동작
   - 쓰기 작업의 효율성을 위해 큰 공간 단위로 공간을 해제
     + LFS의 가비지 컬렉터는 주기적으로 오래된(일부분만 사용된) 세그먼트들을 읽은 후 해당 세그먼트에서 최신 블럭(유효한 내용을 갖는 블럭)들의 개수를 파악
     + 최신 버전 블럭들을 새로운 세그먼트로 이동하며, 유효 블럭들을 모두 이전한 후, 해당 세그먼트는 빈 공간으로 표시
     + 구체적으로 말하자면, 가비지 컬렉터는 M개의 기존 세그먼트들을 모두 읽은 후, 해당 내용으로 N개의 새로운 세그먼트들에 채움 (이 때, N < M / Compact)
     + 그리고 N개의 세그먼트를 디스크의 새로운 위치에 쓰며, 이전의 M개의 세그먼트들은 해제가 되며 파일 시스템이 추후 요청되는 쓰기들의 처리에 사용
