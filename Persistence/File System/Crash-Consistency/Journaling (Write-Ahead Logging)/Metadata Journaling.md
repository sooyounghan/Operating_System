-----
### 메타데이터 저널링
-----
1. 복구 시간 단축은 어느 정도 성공했지만(디스크 전체 스캔하는 것에 비해 저널을 읽고 몇 개 트랜잭션을 재실행함), 파일 시스템이 느려졌음
2. 디스크로 내려가는 모든 쓰기가 저널에 먼저 기록되어야 하므로 쓰기 양이 두 배가 되며, 순차쓰기 워크로드는 특히 치명적이 될 수 있음(디스크 대역폭이 반만 쓸 수 있기 때문임)
   - 더 나아가 저널에 쓰는 것과 주 파일 시스템에 쓰는 것 사이에 탐색 비용이 존재
   - 특정 워크로드의 경우, 심각한 양의 쓰기 오버헤드가 추가될 수 있음

3. 모든 데이터 블럭을 두 번씩 쓰는 방법을 배제하기 위한 기법들이 존재
   - 이제까지 다른 저널링 모드는 모든 데이터를(파일 시스템의 메타데이터와 함께) 저널링하기 때문에 데이터 저널링이라고 불렀음
   - 간단하면서 좀 더 대중적인 저널링 형태는 Ordered Journaling(메타데이터 저널링) : 저널에 데이터 블럭을 기록하지 않는다는 것을 제외하고 대부분 동일
   - 앞에서 수행했던 것과 같은 갱신작업을 수행하면 다음과 같은 정보가 저널에 기록
<div align="center">
<img src="https://github.com/user-attachments/assets/6d14fe62-ffc5-4cf1-8ccc-2fce0badc625">
</div>

   - 이전에는 데이터 블럭 Db가 로그에 기록되었지만, Ordered 모드 저널링에서는 추가적인 쓰기를 피하기 위해 파일 시스템의 원래 위치에 Db를 기록
   - 디스크로 내려가는 I/O 트래픽 대부분이 데이터인 것을 감안하면 두 번씩 쓰지 않는 것만으로도 저널링으로 내려가는 I/O의 오버헤드 정도를 상당히 감소시킬 수 있음

4. Ordered 모드 저널링에서 데이터 블럭을 디스크로 내려보내는 시기
   - 파일에 블럭을 추가하는(Allocation Write) 예제 : 갱신 대상은 I[v2]와 B[v2], Db로 총 세 개
     + 첫 두 개 블럭은 메타데이터이며, 로그에 기록된 후 나중에 체크포인트
     + 마지막 세 번째 블럭은 파일 시스템에 한 번만 기록됨
   - 메타데이터만 저널링 하는 경우 데이터 블럭을 디스크에 내려 보내는 시점이 매우 중요
     + I[v2]와 B[v2]가 저널에 커밋된 후, 디스크에 Db를 기록하면 문제가 발생 : 파일 시스템은 일관된 것처럼 보이지만 I[v2]가 쓰레기 데이터를 가리킬 수 있음
     + I[v2]와 B[v2]은 저널에 기록되었지만, Db에 디스크 아직 기록되지 않은 상황 : 크래시가 발생하여 파일 시스템이 복구를 시도할 것
     + Db가 기록되지 않았으므로, 파일 시스템은 I[v2]와 B[v2]를 재실행하여 체크포인트하고, 파일 시스템이 일관성을 유지하도록 할 것 : 하지만, I[v2]는 쓰레기 데이터를 가리키고 있으므로, Db가 저장되어야 할 위치에 있는 예전 값을 가리킴

   - 💡 해결 방법은 일반적인 파일 시스템(예) Linux의 EXT3)에서는 메타데이터를 저널에 기록하기 전 반드시 관련 데이터 블럭을 먼저 디스크에 씀
     + 데이터 쓰기 : 데이터를 최종 위치에 쓰며, 완료될 때까지 대기 (꼭 대기할 필요는 없음)
     + 저널 메타데이터 쓰기 : 시작 블럭과 메타데이터를 로그에 쓰며, 완료될 때까지 대기
     + 저널 커밋 : 트랜잭션 커밋 블럭을 로그에 씀(TxE 포함), 쓰기가 완료될 때까지 기다리며, 트랜잭션은 이제 (데이터를 포함) 커밋된 상태
     + 체크포인트 메타데이터 : 갱신된 메타데이터 내용을 파일 시스템 상에 있어야 할 최종 위치에 갱신
     + 해제 : 저널 슈퍼블럭에 해당 트랜잭션이 해제되었다고 표기

   - 데이터가 먼저 기록되는 것을 강제해 아이노드 포인터가 쓰레기 데이터를 가리키지 않는 것을 보장
   - 크래시 일관성에 있어서 핵심 법칙 : 포인터 대상이 되는 객체를 그것을 가리키는 객체보다 먼저 쓰는 것

5. 대부분 시스템에서 메타데이터 저널링이 데이터 저널링보다 훨씬 대중적으로 사용
   - Unordered 모드도 존재(Linux의 EXT3) : 임의의 시점에 데이터가 기록될 수 있음
   - Ordered 모드와 Unordered 모드는 둘 다 메타데이터 일관성은 보장하지만, 데이터 일관성에 대한 보장은 다름
   - Unordered 모드의 경우 아이노드가 쓰레기 데이터 블럭을 가리킬 수 있으므로 데이터 일관성은 보장되지 않음

6. 저널링의 올바른 동작에 있어서, 저널 쓰기(2단계) 이전에 데이터 쓰기(1단계)가 반드시 완료될 필요는 없음
   - 데이터 쓰기 요청, 저널 트랜잭션 시작 블럭, 그리고 메타데이터를 함께 요청되도 문제 없음
   - 하지만, 저널 커밋 블럭 요청(3단계)전에 1단계와 2단계는 반드시 완료되어야 함
